function CTable(e,t){var d,O,s,g,c,S,P,f,E,h,N,C,u,T,i,L,B,m,p,o,A,I,R,r,M,b,a,n,l,v,w,G,D,y,_,V,U,X,Y,H,W,x,k,F,K,j,z,J,Q,q=e;this._init=function(e){u=new Array,T=new Array,Q=new Array,J=e,this.reset();var t=s_oSpriteLibrary.getSprite("pool_table");TABLE_CENTER={x:CANVAS_WIDTH/2-t.width/4,y:CANVAS_HEIGHT/2-t.height/4},x=new createjs.Container,s_oStageUpper3D.addChild(x),Y=new createjs.Container,x.x=Y.x=CANVAS_WIDTH/2-t.width/2,x.y=Y.y=CANVAS_HEIGHT/2-t.height/2,q.addChild(Y);e=createBitmap(t);Y.addChild(e),TABLE_CENTER_COORDINATE=new CVector2(CANVAS_WIDTH/2-t.width/4,CANVAS_HEIGHT/2-t.height/4),DEBUG_SHOW_TABLE_CENTER_SHAPE&&this._createGraphicCenterTableShape(),this._initTableEdges(),DEBUG_SHOW_RECT_COLLISION&&((e=new createjs.Shape).graphics.beginStroke("red").drawRect(RECT_COLLISION.x,RECT_COLLISION.y,RECT_COLLISION.width,RECT_COLLISION.height),x.addChild(e));(_=new createjs.Shape).graphics.beginFill("red").drawRect(-150,-150,t.width+300,t.height-60+300),_.alpha=.01,_.cache(-150,-150,t.width+300,t.height-60+300),a=_.on("mousedown",this._onPressHitArea),Y.addChild(_),this.initBalls(),U.enableEvents(),U.addEventListener(ON_PRESS_DOWN_BALL,this._onPressDownCueBall,this),H=new createjs.Container,x.addChild(H),(W=new createjs.Container).visible=!1,Y.addChild(W),this._createTableDownUpperBumper(),V=new CStick(x),this.initStick(),j=ON_CUE_PLACEABLE;t=new createjs.Graphics;w=new createjs.Shape(t),Y.addChild(w);t=new createjs.Graphics;G=new createjs.Shape(t),Y.addChild(G);t=new createjs.Graphics;D=new createjs.Shape(t),Y.addChild(D);t=(new createjs.Graphics).beginStroke("#fff").drawCircle(0,0,BALL_DIAMETER/2);if((y=new createjs.Shape(t)).visible=!1,Y.addChild(y),DEBUG_SHOW_HOLE_CENTER_POS_SHAPE)for(var r=0;r<HOLE_CENTER_POS.length;r++){var s=createGraphicCircle(HOLE_CENTER_POS[r],BALL_RADIUS,null,"#fff");Y.addChild(s)}(v=new CPhysicsController(Y)).addEventListener(ON_BALL_INTO_HOLE,this._onBallInHole,this),v.addEventListener(ON_BALL_WITH_BALL,this._onCollisionBallWithBall,this),v.addEventListener(ON_BALL_WITH_BANK,this._onCollisionBallWithEdge,this),K=S=STATE_TABLE_PLACE_CUE_BALL_BREAKSHOT,this._placeCueBall(),this.updateStick(),R.set(1,0),this.renderStickDirection(),(k=new CHandBallDrag(x)).setPos(U.getX(),U.getY()),k.show(),DEBUG_SHOW_EDGE_TABLE&&this.renderEdges()},this._createTableDownUpperBumper=function(){for(var e=0;e<TABLE_UPPER_BUMPER.length;e++){var t=s_oSpriteLibrary.getSprite(TABLE_UPPER_BUMPER[e].sprite),r=createBitmap(t);r.x=TABLE_UPPER_BUMPER[e].x,r.y=TABLE_UPPER_BUMPER[e].y;var s=t.width/TABLE_UPPER_BUMPER[e].regX,i=t.height/TABLE_UPPER_BUMPER[e].regY;r.regX=s==1/0?0:s,r.regY=i==1/0?0:i,H.addChild(r);t=createBitmap(t);t.x=r.x,t.y=r.y,t.regX=r.regX,t.regY=r.regY,W.addChild(t)}},this._createGraphicCenterTableShape=function(){var e=createGraphicCircle({x:TABLE_CENTER_COORDINATE.getX(),y:TABLE_CENTER_COORDINATE.getY()},10,null,"rgba(255,255,255,1)");Y.addChild(e)},this.addEventListener=function(e,t,r){u[e]=t,T[e]=r},this._onCollisionBallWithBall=function(e,t,r){0!==r&&(r=linearFunction(r,.1,40,.05,1),this._playTableSound("ball_collision",r,100))},this._playTableSound=function(t,e,r){for(var s=!0,i=0,o=(new Date).getTime(),a=0;a<Q.length;a++)Q[a].time>i&&Q[a].name===t&&(i=Q[a].time);return(s=o-i<r?!1:s)&&((e=playSound(t,e,!1)).once("play",function(e){Q.push({time:o,id:e,name:t})}),e.once("end",function(e){for(var t=0;t<Q.lenght;t++)if(Q[t].id===e){Q.splice(t,1);break}})),s},this._onBallInHole=function(e){s_iGameMode==GAME_MODE_TIME?0!=e.getNumber()?(9==e.getNumber()?E+=3*POINTS_FOR_BALL_POT:E+=POINTS_FOR_BALL_POT,s_oInterface.updateScore(E),14==o.length?0:(i++,o.push(e.getNumber())),A.push(e.getNumber())):E>POINTS_FOR_BALL_POT&&(E-=POINTS_FOR_BALL_POT,s_oInterface.updateScore(E)):0!==e.getNumber()?(i++,o.push(e.getNumber()),A.push(e.getNumber())):c=!0;var t=e.getCurForceLen(),r=linearFunction(t,.1,40,.2,1);playSound("ball_in_hole",r,!1),0!==e.getNumber()&&(t=e.getCurForceLen(),s=linearFunction(t,0,13,700,100),e.fadeAnimInHole(s));var s=U.getEdgeCollisionCount(),s=(s=e.getEdgeCollisionCount()+s)<=0?1:s;E+=POINTS_FOR_BALL_POT*s*h,h++},this._onCollisionBallWithEdge=function(e,t=null){var r=e.getCurForceLen();if(0!==r){r=linearFunction(r,.1,40,.1,1);if(this._playTableSound("edge_collision",r,100),t)for(var s=t.getID(),i=0;i<MAIN_TABLE_EDGE.length;i++)MAIN_TABLE_EDGE[i]===s&&e.increaseEdgeCollisionCount()}},this.reset=function(){g=!(c=O=d=!1),E=z=i=L=0,f=h=1,o=new Array,A=new Array,C=new Array,s=!0,N=[7,7],P=0},this.unload=function(){_.off("mousedown",a),_.removeAllEventListeners(),s_oTable=null},this._initTableEdges=function(){I=new Array;for(var e=0;e<FIELD_POINTS.length-1;e++){var t=new CEdge(FIELD_POINTS[e].x,FIELD_POINTS[e].y,FIELD_POINTS[e+1].x,FIELD_POINTS[e+1].y,e);I.push(t)}t=new CEdge(FIELD_POINTS[FIELD_POINTS.length-1].x,FIELD_POINTS[FIELD_POINTS.length-1].y,FIELD_POINTS[0].x,FIELD_POINTS[0].y,FIELD_POINTS.length-1);I.push(t)},this.renderEdges=function(){for(var e=0;e<I.length;e++)I[e].render(H)},this.initBalls=function(){X=new createjs.Container,Y.addChild(X),p=new Array,(U=new CBall(0,X,s_oTextureLibrary.cue_ball)).setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),p[0]=U;for(var e=1;e<BALL_NUMBER+1;e++){var t=s_oTextureLibrary["ball_"+e],t=new CBall(e,X,t);p[e]=t,p[e].setFlagOnTable(!0)}this.setInitBallsPosition(),o=new Array},this.setFirstBallCollision=function(e){C.push(e)},this.setInitBallsPosition=function(){switch(s_iGameMode){case GAME_MODE_NINE:for(var e=new Array(1,2,3,5,6,7,8),t=2;t<BALL_NUMBER;t++){var r=Math.floor(Math.random()*e.length);p[t].setPos(RACK_POS[e[r]].x,RACK_POS[e[r]].y),e.splice(r,1)}p[0].setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),p[1].setPos(RACK_POS[0].x,RACK_POS[0].y),p[9].setPos(RACK_POS[4].x,RACK_POS[4].y);break;case GAME_MODE_EIGHT:for(var s=new Array(0,1,2,3,5,6,7,8,9,11,12,13),i=Math.floor(7*Math.random())+9,o=Math.floor(7*Math.random())+1,t=1;t<BALL_NUMBER+1;t++)8!=t&&t!=i&&t!=o&&(r=Math.floor(Math.random()*s.length),p[t].setPos(RACK_POS[s[r]].x,RACK_POS[s[r]].y),s.splice(r,1));p[i].setPos(RACK_POS[10].x,RACK_POS[10].y),p[o].setPos(RACK_POS[14].x,RACK_POS[14].y),p[8].setPos(RACK_POS[4].x,RACK_POS[4].y);break;case GAME_MODE_TIME:for(e=new Array(0,1,2,3,5,6,7,8,9,10,11,12,13,14),t=1;t<BALL_NUMBER;t++)9!==t&&(r=Math.floor(Math.random()*e.length),p[t].setPos(RACK_POS[e[r]].x,RACK_POS[e[r]].y),e.splice(r,1));p[0].setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),p[9].setPos(RACK_POS[4].x,RACK_POS[4].y)}p.forEach(function(e){this._update3DObjectTransformation(e)},this)},this.initStick=function(){(b=new CVector2).set(-1,0),R=new CVector2(1,0),r=new CVector2,M=new CVector2},this.hitBall=function(){P*=.2,R.scalarProduct(P),U.addForce(R)},this.startToShot=function(){k.hide(),S=STATE_TABLE_MOVE_STICK,d=!0},this._onPressHitArea=function(e){var t;!U.isBallOnTable()||s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()||!v.areBallsStopped()||O||(s_bMobile||s_oTable.startToShot(),U.setDragging(!1),t=Y.globalToLocal(s_oStage.mouseX,s_oStage.mouseY),r.set(t.x,t.y),(F=radiantsToDegrees(Math.atan2(U.getPos().getY()-t.y,U.getPos().getX()-t.x)))<0?F+=360:360<F&&(F-=360),s_bMobile&&(n=_.on("pressmove",s_oTable._onPressMoveHitArea)),l=_.on("pressup",s_oTable._onReleaseHitArea))},this._onPressMoveHitArea=function(e){var t=Y.globalToLocal(e.stageX,e.stageY),e=radiantsToDegrees(Math.atan2(U.getPos().getY()-t.y,U.getPos().getX()-t.x));e<0?e+=360:360<e&&(e-=360);t=e-F;s_oTable.rotateStick(-t),F=e},this.startStickAnimation=function(){return s_oTable._moveStick()},this._moveStick=function(e,t){d=!1;var r=P>=MIN_POWER_SHOT;return r?(O=!(s=!1),U.setSideEffect(s_oInterface.getSideSpin())):(S=K)!==STATE_TABLE_PLACE_CUE_BALL&&S!==STATE_TABLE_PLACE_CUE_BALL_BREAKSHOT||k.show(),r},this._onReleaseHitArea=function(){_.off("pressmove",n),_.off("pressup",l),s_bMobile||S===STATE_TABLE_MOVE_STICK&&s_oTable._moveStick({x:s_oStage.mouseX,y:s_oStage.mouseY},r)},this._onPressDownCueBall=function(e){s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()||S!==STATE_TABLE_PLACE_CUE_BALL_BREAKSHOT&&S!==STATE_TABLE_PLACE_CUE_BALL||(U.addEventListener(ON_PRESS_MOVE_BALL,this._onPressMoveCueBall,this),U.addEventListener(ON_PRESS_UP_BALL,this._onPressUpCueBall,this),U.setFlagOnTable(!1),V.setVisible(!0),k.setPos(U.getX(),U.getY()))},this._onPressMoveCueBall=function(e){e={x:e.stageX,y:e.stageY};this._moveCueBall(e),this.updateStick(),this.renderStickDirection(),j=this._checkCueBallCollisionWithTableElements()?(s_oGame.hideShotBar(),ON_CUE_NOT_PLACEABLE):(s_oGame.showShotBar(),ON_CUE_PLACEABLE),k.setPos(U.getX(),U.getY())},this._onPressUpCueBall=function(){U.removeEventListener(ON_PRESS_MOVE_BALL),U.removeEventListener(ON_PRESS_UP_BALL),this._placeCueBall(),this.updateStick(),this.renderStickDirection(),k.setPos(U.getX(),U.getY())},this._checkCueBallCollisionWithTableElements=function(){if(U.getX()>CUE_BALL_RESPOT_1.x&&U.getX()<CUE_BALL_RESPOT_3.x&&U.getY()>CUE_BALL_RESPOT_1.y&&U.getY()<CUE_BALL_RESPOT_3.y){var e=new CVector2;e.set(U.getX(),U.getY());for(var t=1;t<BALL_NUMBER+1;t++)if(distance2(e,p[t].getPos())<=BALL_DIAMETER_QUADRO)return!0}return!1},this._placeCueBall=function(){this._checkCueBallCollisionWithTableElements()||(H.visible=!0,W.visible=!1,U.setDragging(!1),U.setFlagOnTable(!0))},this._moveCueBall=function(e){e=Y.globalToLocal(e.x,e.y);e.y-BALL_RADIUS>FIELD_POINTS[1].y&&e.y+BALL_RADIUS<FIELD_POINTS[13].y&&U.setY(e.y),S===STATE_TABLE_PLACE_CUE_BALL&&e.x+BALL_RADIUS<FIELD_POINTS[9].x&&e.x-BALL_RADIUS>FIELD_POINTS[21].x&&U.setX(e.x)},this._checkCpuBallCollision=function(e,t,r,s,i){var o=new CVector2,a=new CVector2,n=new CVector2;n.setV(e),n.subtract(t);var l=n.length();n.normalize(),o.setV(n),a.setV(n),o.rot90CCW(),a.rot90CW(),o.scalarProduct(BALL_RADIUS),a.scalarProduct(BALL_RADIUS),o.add(t),a.add(t);e=new CVector2,t=new CVector2;e.setV(n),t.setV(n),e.scalarProduct(l),t.scalarProduct(l),e.add(o),t.add(a);var _=new CEdge;_.set(a.getX(),a.getY(),t.getX(),t.getY());var g=new CEdge;g.set(o.getX(),o.getY(),e.getX(),e.getY());for(var c=!1,E={iDistance:0,vClosestPoint:new CVector2},h=0;h<BALL_NUMBER+1;h++)h!=r&&h!=s&&(collideEdgeWithCircle(_,p[h].getPos(),BALL_RADIUS,E)&&(c=!0,i.push({ball:p[h],point:E.vClosestPoint})),collideEdgeWithCircle(g,p[h].getPos(),BALL_RADIUS,E)&&(c=!0,i.push({ball:p[h],point:E.vClosestPoint})));return c},this.renderStickDirection=function(){if(w.graphics.clear(),G.graphics.clear(),D.graphics.clear(),y.x=CANVAS_WIDTH+100,y.y=CANVAS_HEIGHT+100,!1===d)if(O){var e,t=new CVector2,r=new CVector2;r.set(V.getX(),V.getY()),L+=s_iTimeElaps,100<P?e=easeElasticIn(L,0,1,TIME_ANIMATION_SHOT_ELASTIC,-1):(e=easeBackIn(L,0,1,TIME_ANIMATION_SHOT_BACK),P<MIN_POWER_SHOT&&(P=MIN_POWER_SHOT)),t=tweenVectors(r,U.getPos(),t,e),B<=L&&(s_oGame.hideShotBar(),i=linearFunction(P,MIN_POWER_SHOT,MAX_POWER_SHOT,.3,1),playSound("stick_shot",i,!1),L=0,O=!1,P*=.2,R.scalarProduct(P),U.addForce(R),R.normalize(),o=s_oInterface.getSideSpin()*(.5*Math.sign(R.getX())),C=(a=s_oInterface.getBackSpin()*(.5*Math.sign(R.getY())))-(h=o+a*R.getX())*Math.sign(R.getX()),U.setEffectForceX(-h),U.setEffectForceY(-C),U.getEffectForceVector().add(R),V.setVisible(!1),S=STATE_TABLE_SHOOTING),V.setPos(t.getX(),t.getY())}else{var s=new Array,i=new CVector2,o={x:1280*R.getX()+U.getX(),y:1280*R.getY()+U.getY()};i.set(o.x,o.y);var a=new CVector2;a.setV(i),a.subtract(U.getPos()),a.normalize();this._checkCpuBallCollision(i,U.getPos(),0,0,s);for(var n=0;n<s.length;n++)s[n].ball.isBallOnTable()||(s.splice(n,1),n--);if(0<s.length){for(var l,_=distance(U.getPos(),s[0].ball.getPos()),g=0,c=1;c<s.length;c++)s[c].ball.isBallOnTable()&&((l=distance(U.getPos(),s[c].ball.getPos()))<_&&(_=l,g=c));(new CEdge).set(U.getX(),U.getY(),i.getX(),i.getY()),(T=new CVector2).setV(a),T.scalarProduct(1.5);var E=new CVector2;for(E.setV(U.getPos());distance(E,s[g].ball.getPos())>BALL_DIAMETER+1;)E.add(T);var h=new CVector2;h.setV(s[g].ball.getPos()),h.subtract(E),h.normalize();var C=new CVector2;h.invert(),(C=reflectVectorV2(h,a)).normalize(),C.scalarProduct(48);t=new CVector2;t.setV(E),t.add(C);h=new CVector2;h.setV(s[g].ball.getPos()),h.subtract(E),h.normalize(),h.scalarProduct(72);C=new CVector2;C.setV(E),C.add(h),y.visible=!0,y.x=E.getX(),y.y=E.getY(),w.graphics.setStrokeStyle(4).beginStroke(PREVISION_TRAJECTORY_COLORS[0][j]).moveTo(U.getX(),U.getY()).lineTo(E.getX(),E.getY()),G.graphics.setStrokeStyle(4).beginStroke(PREVISION_TRAJECTORY_COLORS[0][j]).moveTo(E.getX(),E.getY()).lineTo(t.getX(),t.getY()),D.graphics.setStrokeStyle(4).beginStroke(PREVISION_TRAJECTORY_COLORS[1][j]).moveTo(E.getX(),E.getY()).lineTo(C.getX(),C.getY())}else{(new CEdge).set(U.getX(),U.getY(),i.getX(),i.getY());var u=new CEdge;if(null!==(u=function(e,t,r){var s=new CVector2,i=new CVector2,o=new CVector2;o.setV(e),o.subtract(t);var a=o.length();o.normalize(),s.setV(o),i.setV(o),s.rot90CCW(),i.rot90CW(),s.scalarProduct(BALL_RADIUS),i.scalarProduct(BALL_RADIUS),s.add(t),i.add(t),e=new CVector2,t=new CVector2,e.setV(o),t.setV(o),e.scalarProduct(a),t.scalarProduct(a),e.add(s),t.add(i);var n=new CEdge;n.set(i.getX(),i.getY(),t.getX(),t.getY());var l=new CEdge;l.set(s.getX(),s.getY(),e.getX(),e.getY());for(var _=new CEdge,g=!1,c=0;c<r.length;c++){if(collideEdgeWithEdge(n,r[c])){_=r[c],g=!0;break}if(collideEdgeWithEdge(l,r[c])){_=r[c],g=!0;break}}return g?_:null}(i,U.getPos(),I))){var T,A=new CVector2;for((T=new CVector2).setV(a),T.scalarProduct(2),A.setV(U.getPos());!collideEdgeWithCircle(u,A,BALL_RADIUS);)A.add(T);y.visible=!0,y.x=A.getX(),y.y=A.getY(),w.graphics.beginStroke(PREVISION_TRAJECTORY_COLORS[0][j]).moveTo(U.getX(),U.getY()).lineTo(A.getX(),A.getY())}else y.visible=!1,w.graphics.beginStroke(PREVISION_TRAJECTORY_COLORS[0][j]).moveTo(U.getX(),U.getY()).lineTo(U.getX()+R.getX()*m,U.getY()+R.getY()*m)}V.setPos(U.getX(),U.getY());a=toDegree(angleBetweenVectors(b,R));(o={x:1280*R.getX()+U.getX(),y:1280*R.getY()+U.getY()}).y>U.getY()&&(a=180-a+180),V.setRotation(a+180)}else V.setPos(U.getX()+M.getX()*P,U.getY()+M.getY()*P)},this.updateStick=function(){var e=new CVector2,t=Y.globalToLocal(s_oStage.mouseX,s_oStage.mouseY);e.set(t.x,t.y),!1===d?!0===O?(L+=s_iTimeElaps,B<L&&(L=B)):((t=!s_bMobile&&U.isBallOnTable())&&(R.setV(e),R.subtract(U.getPos())),m=R.length(),t&&R.normalize(),M.setV(R),M.invert()):s_bMobile||(e.subtract(r),e=e.length(),this.holdShotStickMovement(e))},this.holdShotStickMovement=function(e){(P=e)>MAX_POWER_SHOT&&(P=MAX_POWER_SHOT),B=100<P?TIME_ANIMATION_SHOT_ELASTIC:TIME_ANIMATION_SHOT_BACK},this.renderBalls=function(){for(var e=0;e<p.length;e++)s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()?p[e].render(!0):p[e].render(!1)},this.respotCueBall=function(){U.setDragging(!0),S=STATE_TABLE_PLACE_CUE_BALL,H.visible=!1,W.visible=!0,s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()||(K=S,U.setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),V.setVisible(!0),k.setPos(U.getX(),U.getY(0)),k.show())},this.rotateStick=function(e){S===STATE_TABLE_SHOOT||S===STATE_TABLE_SHOOTING||s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()||O||(rotateVector2D(toRadian(e),R),this.updateStick(),this.renderStickDirection())},this.checkTurn=function(){var e=!1,t=!1,r=!1;switch(s_iGameMode){case GAME_MODE_NINE:var s=C[0];if(0<C.length&&s.getNumber()===f){if(c){if(c=!1,s_oGame.changeTurn(),this.respotCueBall(),!1===p[9].isBallOnTable()){for(var i=!1,o=0;!i;){p[9].setPos(RACK_POS[4].x+o,RACK_POS[4].y),i=!0;for(var a=0;a<8;a++){if(distance2(p[9].getPos(),p[a].getPos())<=BALL_DIAMETER_QUADRO){i=!1;break}o+=BALL_RADIUS}}p[9].setFlagOnTable(!0),p[9].setVisible(!0)}}else if(0<A.length){for(var n=0;n<A.length;n++)if(9==A[n])return p[9].setVisible(!0),void(s_iPlayerMode==GAME_MODE_CPU?2==s_oGame.getCurTurn()?(u[ON_END_GAME]&&u[ON_LOST].call(T[ON_LOST]),s_oGame.resetWinStreak()):(u[ON_WON]&&u[ON_WON].call(T[ON_WON],"YOU"),s_oGame.increaseWinStreak()):1==s_oGame.getCurTurn()?u[ON_WON]&&u[ON_WON].call(T[ON_WON],s_oGame.getPlayer1Name()):u[ON_WON]&&u[ON_WON].call(T[ON_WON],s_oGame.getPlayer2Name()));V.setVisible(!0)}else s_oGame.changeTurn(),V.setVisible(!0);g=!1}else{if(g)U.setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),s_oGame.changeTurn(),this.targetting(!0);else{if(0==p[9].isBallOnTable()){for(i=!1,o=0;!i;){p[9].setPos(RACK_POS[4].x+o,RACK_POS[4].y),i=!0;for(a=0;a<8;a++){if(distance2(p[9].getPos(),p[a].getPos())<=BALL_DIAMETER_QUADRO){i=!1;break}o+=BALL_RADIUS}}p[9].setFlagOnTable(!0),p[9].setVisible(!0)}s_oGame.changeTurn(),this.respotCueBall(),g=!1}c=!1}C.splice(0),A.splice(0);break;case GAME_MODE_EIGHT:if(!1===p[8].isBallOnTable())return void(0===N[s_oGame.getCurTurn()-1]?(r=!0,s_iPlayerMode==GAME_MODE_CPU?2==s_oGame.getCurTurn()?(u[ON_LOST]&&u[ON_LOST].call(T[ON_LOST],TEXT_GAME_OVER,E),s_oGame.resetWinStreak()):(u[ON_WON]&&u[ON_WON].call(T[ON_WON],TEXT_YOU_WON,E),s_oGame.increaseWinStreak()):1===s_oGame.getCurTurn()?u[ON_WON]&&u[ON_WON].call(T[ON_WON],sprintf(TEXT_PLAYER_NAME_WON,s_oGame.getPlayer1Name()),E):u[ON_WON]&&u[ON_WON].call(T[ON_WON],sprintf(TEXT_PLAYER_NAME_WON,s_oGame.getPlayer2Name()),E)):s_iPlayerMode==GAME_MODE_CPU?2==s_oGame.getCurTurn()?(u[ON_WON]&&u[ON_WON].call(T[ON_WON],TEXT_YOU_WON,E),s_oGame.increaseWinStreak()):(u[ON_LOST]&&u[ON_LOST].call(T[ON_LOST],TEXT_GAME_OVER,E),s_oGame.resetWinStreak()):1==s_oGame.getCurTurn()?u[ON_WON]&&u[ON_WON].call(T[ON_WON],sprintf(TEXT_PLAYER_NAME_WON,s_oGame.getPlayer2Name()),E):u[ON_WON]&&u[ON_WON].call(T[ON_WON],sprintf(TEXT_PLAYER_NAME_WON,s_oGame.getPlayer1Name()),E));if(c){c=!1,s_oGame.changeTurn(!0),e=t=!0,this._assignSuit(),this.respotCueBall();for(n=0;n<A.length;n++)s_oGame.isLegalShotFor8Ball(A[n])?N[s_oGame.getCurTurn()-1]--:N[s_oGame.getNextTurn()-1]--}else if(0!==C.length&&s_oGame.isLegalShotFor8Ball(C[0].getNumber(),N[s_oGame.getCurTurn()-1]))if(0<A.length)if(this._assignSuit())0==N[s_oGame.getCurTurn()-1]&&s_oGame.setNextBallToHit(8),V.setVisible(!(s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()));else if(s_oGame.isLegalShotFor8Ball(A[0])){var l=!0;if(N[s_oGame.getCurTurn()-1]--,1<A.length){for(n=1;n<A.length;n++)s_oGame.isLegalShotFor8Ball(A[n])?N[s_oGame.getCurTurn()-1]--:(l=!1,N[s_oGame.getNextTurn()-1]--);0==N[s_oGame.getCurTurn()-1]&&s_oGame.setNextBallToHit(8),(e=l)||(s_oGame.changeTurn(!0),t=!0)}0==N[s_oGame.getCurTurn()-1]&&s_oGame.setNextBallToHit(8),V.setVisible(!(s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()))}else{s_oGame.changeTurn(!0),e=t=!0,this.respotCueBall();for(n=0;n<A.length;n++)s_oGame.isLegalShotFor8Ball(A[n])?N[s_oGame.getCurTurn()-1]--:N[s_oGame.getNextTurn()-1]--;0===N[s_oGame.getCurTurn()-1]&&s_oGame.setNextBallToHit(8)}else s_oGame.changeTurn(!1),t=!0,V.setVisible(!(s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()));else{for(n=0;n<A.length;n++)s_oGame.isLegalShotFor8Ball(A[n])?N[s_oGame.getCurTurn()-1]--:N[s_oGame.getNextTurn()-1]--;0==N[s_oGame.getCurTurn()-1]&&s_oGame.setNextBallToHit(8),s_oGame.changeTurn(!0),e=t=!0,this.respotCueBall()}C.splice(0),A.splice(0)}U.isDragging()||(s_iPlayerMode!==GAME_MODE_CPU||1===s_oGame.getCurTurn()?(s_bMobile,K=S=STATE_TABLE_MOVE_STICK,s_oGame.showShotBar()):S=STATE_TABLE_SHOOT),s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()||(this.updateStick(),this.renderStickDirection()),t&&(z=0,h=1);var _=t?2:1;return s_iPlayerMode===GAME_MODE_CPU&&s_oGame.getCurTurn()===_&&(e&&(E=POINTS_FOR_FAULT),s_oGame.updateScore(E)),E=0,r},this.isCpuTurn=function(){return s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()},this.targetting=function(e){V.setVisible(e)},this._assignSuit=function(){var e=7===N[0]&&7===N[1];if(e){for(var t=0,r=0,s=0;s<A.length;s++)8<A[s]?t++:r++;if(r<t){s_oGame.assignSuits(9);for(var i=0;i<t;i++)A[s_oGame.getCurTurn()-1]--;for(var o=0;o<r;o++)A[s_oGame.getNextTurn()-1]--}else{s_oGame.assignSuits(1);for(i=0;i<r;i++)N[s_oGame.getCurTurn()-1]--;for(o=0;o<t;o++)N[s_oGame.getNextTurn()-1]--}}return e},this.prepareNextTurn=function(){L=0,++z>J.length-1&&(z=J.length-1);var e=this.checkTurn();s_iPlayerMode!=GAME_MODE_CPU||2!==s_oGame.getCurTurn()||e||setTimeout(function(){s_oTable.calculateCpuShot()},2e3),A.splice(0)},this.calculateCpuShot=function(){var e=!0;switch(s_iGameMode){case GAME_MODE_NINE:var t=v.getEdges();if(null!==(T=this.setHoleToAim(U,p[f],f,t))?(e=!0,(e=U.isDragging()?this.respotCpuCueBall(T.coll):e)&&!this.findCollisionForCueBall(T.coll)&&(e=!1)):e=!1,!e)for(var r=f+1;r<BALL_NUMBER+1;r++)if(null!=(T=this.setHoleToAim(p[f],p[r],r,t))){var s=new CVector2;if(s.setV(this.findCollisionPoint(T.coll.getX(),T.coll.getY(),p[f])),e=!U.isDragging()||this.respotCpuCueBall(s)){if(this.findCollisionForCueBall(s)){e=!0;break}e=!1}}else e=!1;if(!e){var i=new Array,o=new Array,a=new Array;i=this.setAllHolesToAim(U,p[f],f,t);for(var n=new CVector2,l=0;l<i.length;l++)o[l]=i[l].dist,(d=new CVector2).setV(i[l].coll),e=!0,(e=U.isDragging()?this.respotCpuCueBall(d):e)&&(n.set(0,-1),a[l]=this._getEdgeShot(d,n,t),e=void 0===a[l]?(o[l]+=9e3,!1):(o[l]+=a[l].dist,!0));if(e){for(var _=o[0],g=0,c=1;c<o.length;c++)o[c]<_&&(_=o[c],g=c);this.cpuShot(a[g].dir)}else(S=new CVector2).setV(p[f].getPos()),S.subtract(U.getPos()),S.normalize(),U.isDragging()&&U.setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),this.cpuShot(S)}break;case GAME_MODE_EIGHT:e=!1;t=v.getEdges();if(0===N[s_oGame.getCurTurn()-1]){if(null!==(T=this.setHoleToAim(p[0],p[8],8,t))?(e=!0,(e=p[0].isDragging()?this.respotCpuCueBall(T.coll,8):e)&&!this.findCollisionForCueBall(T.coll,p[8],new CVector2(T.hole.x,T.hole.y))&&(e=!1)):e=!1,!e){i=new Array,o=new Array,a=new Array;i=this.setAllHolesToAim(p[0],p[8],8,t);for(n=new CVector2,l=0;l<i.length;l++)o[l]=i[l].dist,(d=new CVector2).setV(i[l].coll),e=(e=!U.isDragging()||this.respotCpuCueBall(d,8))&&this.prepareEdgeShot(l,d,n,t,o);e||((S=new CVector2).setV(p[8].getPos()),S.subtract(p[0].getPos()),S.normalize(),p[0].isDragging()&&p[0].setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),this.cpuShot(S))}}else{var E=1,h=BALL_NUMBER+1,C=new Array;s_oGame.isSuiteAssigned()&&(h="solid"==s_oGame.getSuiteForCurPlayer()?(E=1,9):(E=9,16));for(var u=E;u<h;u++)8!==u&&p[u].isBallOnTable()&&C.push(p[u]);for(var T,l=0;l<C.length;l++)if(null!==(T=this.setHoleToAim(p[0],C[l],C[l].getNumber(),I))){var A,e=!0;if(DEBUG_SHOW_CPU_BALL_TRAJECTORY&&(console.log("palla : "+C[l].getNumber()),console.log(T),console.log("*********"),A={x:T.coll.getX(),y:T.coll.getY()},Y.addChild(createGraphicCircle(A,6,1e4,"#fff")),Y.addChild(createGraphicLine(A,T.hole,3,1e4,"#fff"))),!(e=U.isDragging()?this.respotCpuCueBall(T.coll,C[l].getNumber()):e)||this.findCollisionForCueBall(T.coll,C[l],new CVector2(T.hole.x,T.hole.y)))break;e=!1}else e=!1;if(!e)for(u=0;u<C.length;u++){i=new Array,o=new Array;i=this.setAllHolesToAim(U,C[u],u,t);for(var d,n=new CVector2,l=0;l<i.length;l++)o[l]=i[l].dist,(d=new CVector2).setV(i[l].coll),e=(e=!U.isDragging()||this.respotCpuCueBall(d,C[u].getNumber()))&&this.prepareEdgeShot(l,d,n,t,o)}if(!e){for(var O,S,u=E;u<h;u++)if((8!==u||0===N[s_oGame.getCurTurn()-1])&&p[u].isBallOnTable()){var P=!1,L=new CEdge;L.set(U.getX(),U.getY(),p[u].getX(),p[u].getY()),O=p[u];for(var B=1;B<BALL_NUMBER+1;B++)if(B!==u&&collideEdgeWithCircle(L,p[B].getPos(),BALL_DIAMETER)){P=!0;break}if(!P)break}(S=new CVector2).setV(O.getPos()),S.subtract(U.getPos()),S.normalize(),U.isDragging()&&U.setPos(CUE_BALL_POS.x,CUE_BALL_POS.y),this.cpuShot(S)}}}},this.respotCpuCueBall=function(e,t){var r;switch(s_iGameMode){case GAME_MODE_NINE:r=f;break;case GAME_MODE_EIGHT:r=t}var s=new CVector2;s.setV(p[r].getPos()),s.subtract(e),s.normalize(),s.invert(),s.scalarProduct(2*BALL_DIAMETER),s.add(e);for(var i=r+1;i<p.length;i++)if(distance2(s,p[i].getPos())<=BALL_DIAMETER_QUADRO)return!1;return s.getX()>CUE_BALL_RESPOT_1.x&&s.getX()<CUE_BALL_RESPOT_3.x&&s.getY()>CUE_BALL_RESPOT_1.y&&s.getY()<CUE_BALL_RESPOT_3.y?(U.setPos(s.getX(),s.getY()),U.setDragging(!1),!0):(console.trace("no respotCpuCueBall "+s.getX()+","+s.getY()),!1)},this.findCollisionPoint=function(e,t,r){var s=new CVector2;s.set(e,t),s.subtract(r.getPos()),s.normalize(),s.invert();e=new CVector2,t=randomFloatBetween(J[z].min,J[z].max);return s.scalarProduct(BALL_DIAMETER*t),s.add(r.getPos()),e.setV(s),e},this.cpuShot=function(e,t=MAX_FORCE_PER_DISTANCE){t=t>MAX_FORCE_PER_DISTANCE?MAX_FORCE_PER_DISTANCE:t,P=linearFunction(t,0,MAX_FORCE_PER_DISTANCE,3,MAX_POWER_SHOT),R.setV(e),B=100<P?TIME_ANIMATION_SHOT_ELASTIC:TIME_ANIMATION_SHOT_BACK,V.setPos(p[0].getX(),p[0].getY()),d=!0;var r=new CVector2;r.setV(R),r.invert(),r.normalize(),r.scalarProduct(Math.floor(P/10));t=new CVector2;t.set(V.getX(),V.getY()),r.add(t);t=toDegree(angleBetweenVectors(b,R));0<e.getY()&&(t=180-t+180),V.setRotation(t+180),V.setVisible(!0),V.setPos(r.getX(),r.getY()),O=!(d=!1),S=STATE_TABLE_SHOOT},this.findCollisionForCueBall=function(e,t,r){if(this._checkCpuBallCollision(e,U.getPos(),0,0,new Array))return!1;r=distance(t,r)+distance(t,U.getPos()),t=new CVector2;return t.setV(e),t.subtract(U.getPos()),t.scalarProduct(.3),t.normalize(),this.cpuShot(t,r),!0},this.setAllHolesToAim=function(e,t,r,s){for(var i=new Array,o=0;o<HOLE_CPU_POINTS.length;o++){var a=new CEdge;a.set(t.getX(),t.getY(),HOLE_CPU_POINTS[o].x,HOLE_CPU_POINTS[o].y);for(var n=distance(a.getPointA(),a.getPointB()),l=!1,_=0;_<BALL_NUMBER+1;_++)if(_!=r&&collideEdgeWithCircle(a,p[_].getPos(),BALL_DIAMETER)){l=!0;break}for(var g=0;g<s.length;g++)if(collideEdgeWithEdge(a,s[g])){l=!0;break}l||i.push({coll:this.findCollisionPoint(HOLE_CPU_POINTS[o].x,HOLE_CPU_POINTS[o].y,t),dist:n})}if(0===i.length)return[];for(var c=i.length,E=0;0<c;){var h=i[E].coll,C=!0;!(C=0===e.getNumber()&&e.isDragging()?this.respotCpuCueBall(h,t.getNumber()):C)||this._checkCpuBallCollision(h,e.getPos(),e.getNumber(),r,new Array)?i.splice(E,1):E++,c--}return i},this.setHoleToAim=function(e,t,r,s){for(var i=new Array,o=1.1*BALL_RADIUS,a=0;a<6;a++){var n=new CEdge;n.set(t.getX(),t.getY(),HOLE_CPU_POINTS[a].x,HOLE_CPU_POINTS[a].y);for(var l=distance2(n.getPointA(),n.getPointB()),_=!1,g=0;g<BALL_NUMBER+1;g++)if(g!=r&&collideEdgeWithCircle(n,p[g].getPos(),BALL_DIAMETER)){_=!0;break}for(var c=0;c<s.length;c++)if(collideEdgeWithEdge(n,s[c])){_=!0;break}for(var E=lineInterpolate(n,o,3),s=v.getEdgesByHoleID(a),h=0;h<E.length&&!_;h++)for(var C=0;C<s.length;C++)if(_=collideEdgeWithCircle(s[C],E[h],o)){DEBUG_SHOW_PREDICT_TRAJECTORY_COLLISION&&(Y.addChild(createGraphicLine({x:t.getX(),y:t.getY()},HOLE_CPU_POINTS[a],3,6e3,"#f0f")),Y.addChild(createGraphicCircle({x:E[h].getX(),y:E[h].getY()},o,6e3,"#0ff")));break}if(!_){for(var u=this.findCollisionPoint(HOLE_CPU_POINTS[a].x,HOLE_CPU_POINTS[a].y,t),T=v.getEdgesByHoleID(a),A=!1,g=0;g<T.length;g++)if(collideEdgeWithCircle(s[g],u,BALL_RADIUS)){A=!0;break}A?DEBUG_SHOW_PREDICT_TRAJECTORY_COLLISION&&Y.addChild(createGraphicCircle({x:u.getX(),y:u.getY()},o,6e3,"#0f0")):i.push({hole:HOLE_CPU_POINTS[a],coll:u,dist:l})}}if(0===i.length)return null;sortByKey(i,"dist");for(var d=i.length,O=0;0<d;){var S=i[O].coll,P=!0;!(P=0===e.getNumber()&&e.isDragging()?this.respotCpuCueBall(S,t.getNumber()):P)||this._checkCpuBallCollision(S,e.getPos(),e.getNumber(),e.getNumber(),new Array)?i.splice(O,1):O++,d--}return 0==i.length?null:i[0]},this._getEdgeShot=function(e,t,r){var s=new CVector2;s.setV(e);var i=1,o=new CEdge;t.scalarProduct(600);for(var a=new Array;i<360;){rotateVector2D(toRadian(1),t);var n=new CVector2;n.set(s.getX()+t.getX(),s.getY()+t.getY()),o.set(e.getX(),e.getY(),n.getX(),n.getY());for(var l,_,g,c,E=new CVector2,h=0;h<r.length;h++)collideEdgeWithEdge(o,r[h],E)&&(g=r[h],(l=new CVector2).setV(reflectVectorV2(t,g.getNormal())),_=new CEdge,(c=new CVector2).setV(l),c.add(E),_.set(E.getX(),E.getY(),c.getX(),c.getY()),(g=distance(E,e))>BALL_DIAMETER&&collideEdgeWithCircle(_,U.getPos(),BALL_RADIUS)&&(c=!1,(c=this._checkCpuBallCollision(E,U.getPos(),0,0,new Array)||this._checkCpuBallCollision(e,E,0,0,new Array)?!0:c)||(l.invert(),l.normalize(),(c=new CVector2).setV(l),d=distance(_.getPointA(),_.getPointB()),a.push({dir:c,edge:_,dist:d+g}))));i+=1}if(0!==a.length){for(var C=closestPointOnLine(a[0].edge.getPointA(),a[0].edge.getPointB(),U.getPos()),u=distance(C,U.getPos()),T=0,A=1;A<a.length;A++){var d,C=closestPointOnLine(a[A].edge.getPointA(),a[A].edge.getPointB(),U.getPos());(d=distance(C,U.getPos()))<u&&(u=d,T=A)}return a[T]}},this.prepareEdgeShot=function(e,t,r,s,i){var o=new Array;r.set(0,-1);if(o[e]=this._getEdgeShot(t,r,s),null==o[e]?(i[e]+=9e3,!1):(i[e]+=o[e].dist,!0))this._edgeShot(i,o);else if(r.set(1,0),o[e]=this._getEdgeShot(t,r,s),void 0===o[e]?(i[e]+=9e3,!1):(i[e]+=o[e].dist,!0))this._edgeShot(i,o);else{if(r.set(0,1),o[e]=this._getEdgeShot(t,r,s),!(null==o[e]?(i[e]+=9e3,!1):(i[e]+=o[e].dist,!0)))return r.set(-1,0),o[e]=this._getEdgeShot(t,r,s),null==o[e]?(i[e]+=9e3,!1):(i[e]+=o[e].dist,!0);this._edgeShot(i,o)}},this._edgeShot=function(e,t){if(void 0!==t){for(var r=e[0],s=0,i=1;i<e.length;i++)e[i]<r&&(r=e[i],s=i);t=void 0===(t=t[s])?void 0:t.dir;this.cpuShot(t)}},this.setLowestBall=function(){for(var e=1;e<p.length;e++)if(p[e].isBallOnTable()){f=e;break}},this.isBreakShot=function(){return s},this.getCntBallsIntoHoles=function(){return i},this.updatePhysics=function(){var e=v.areBallsStopped();v.update(p);var t=v.areBallsStopped();if(!e&&t){s_oInterface.resetSpin(),this.prepareNextTurn();for(var r=P=0;r<p.length;r++)p[r].resetEdgeCollisionCount()}},this.getTableX=function(){return Y.x},this.getTableY=function(){return Y.y},this._update3DObjectTransformation=function(e){var t=e.getX(),r=e.getY(),s=e.getObject3D();s.position.x=.5*-CANVAS_WIDTH+t+this.getTableX(),s.position.y=.5*CANVAS_HEIGHT-r-this.getTableY();t=e.getCurForce(),r=e.getEffectForceVector(),e=new CVector2(t.getX(),t.getY());e.add(r);t=.04*e.length();e.normalize(),r.scalarProduct(DAMPING_BALL_EFFECT),s.rotateOnWorldAxis(new THREE.Vector3(e.getY(),e.getX(),0),t)},this.update=function(){this.updatePhysics(),this.renderBalls();var e=this.isCpuTurn();switch(S){case STATE_TABLE_PLACE_CUE_BALL:case STATE_TABLE_PLACE_CUE_BALL_BREAKSHOT:case STATE_TABLE_MOVE_STICK:if(e)return;this.updateStick(),this.renderStickDirection();break;case STATE_TABLE_SHOOT:s_iPlayerMode===GAME_MODE_CPU&&2===s_oGame.getCurTurn()&&O&&this.renderStickDirection();break;case STATE_TABLE_SHOOTING:}p.forEach(function(e){this._update3DObjectTransformation(e),e._updateShadow()},this)},(s_oTable=this)._init(t)}var s_oTable=null;