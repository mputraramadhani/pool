function CPhysicsController(e){var u,h,_,L,t,c,g,N,A,n,p,i,E,B,P,I,O,d,C,T,F,f,m,o=this;this._init=function(e){u=!0,t=0,h=new Array,_=new Array,this._initCollisions()},this._initCollisions=function(){new Array,m=new createjs.Rectangle(0,0,POOL_HOLE_RADIUS,POOL_HOLE_RADIUS),c=new Array,g=new Array,N=new Array,A=new Array,new Array,n=new Array;for(var e=0;e<FIELD_POINTS.length-1;e++){var t=new CEdge(FIELD_POINTS[e].x,FIELD_POINTS[e].y,FIELD_POINTS[e+1].x,FIELD_POINTS[e+1].y,e);n.push(t)}t=new CEdge(FIELD_POINTS[FIELD_POINTS.length-1].x,FIELD_POINTS[FIELD_POINTS.length-1].y,FIELD_POINTS[0].x,FIELD_POINTS[0].y,FIELD_POINTS.length-1);n.push(t),c.push(n[21]),c.push(n[22]),c.push(n[23]),c.push(n[0]),c.push(n[1]),c.push(n[2]),c.push(n[3]),c.push(n[4]),(p=new Array).push(n[0]),p.push(n[2]),p.push(n[3]),p.push(n[4]),g.push(n[3]),g.push(n[4]),g.push(n[5]),g.push(n[6]),g.push(n[7]),g.push(n[8]),g.push(n[9]),p.push(n[8]),p.push(n[7]),p.push(n[6]),A.push(n[9]),A.push(n[10]),A.push(n[11]),A.push(n[12]),A.push(n[13]),A.push(n[14]),A.push(n[15]),A.push(n[16]),p.push(n[10]),p.push(n[11]),p.push(n[12]),p.push(n[14]),p.push(n[15]),p.push(n[16]),N.push(n[15]),N.push(n[16]),N.push(n[17]),N.push(n[18]),N.push(n[19]),N.push(n[20]),N.push(n[21]),p.push(n[18]),p.push(n[19]),p.push(n[20]),p.push(n[22]),p.push(n[23]),i=new Array;for(var r=0;r<FIELD_POINTS.length;r++){var o=new CVector2(FIELD_POINTS[r].x,FIELD_POINTS[r].y);i.push(o)}E=new Array,B=new Array,P=new Array,I=new Array,O=new Array;var s=new CVector2;s.set((n[0].getNormal().getX()+n[23].getNormal().getX())/2,(n[0].getNormal().getY()+n[23].getNormal().getY())/2),s.normalize(),E.push(s);for(r=0;r<23;r++){var a=new CVector2((n[r].getNormal().getX()+n[r+1].getNormal().getX())/2,(n[r].getNormal().getY()+n[r+1].getNormal().getY())/2);a.normalize(),E.push(a)}B.push({oPoint:i[1],oNormal:E[1]}),B.push({oPoint:i[2],oNormal:E[2]}),B.push({oPoint:i[5],oNormal:E[5]}),B.push({oPoint:i[21],oNormal:E[21]}),P.push({oPoint:i[2],oNormal:E[2]}),P.push({oPoint:i[5],oNormal:E[5]}),P.push({oPoint:i[6],oNormal:E[6]}),P.push({oPoint:i[9],oNormal:E[9]}),O.push({oPoint:i[10],oNormal:E[10]}),O.push({oPoint:i[13],oNormal:E[13]}),O.push({oPoint:i[14],oNormal:E[14]}),O.push({oPoint:i[17],oNormal:E[17]}),I.push({oPoint:i[14],oNormal:E[14]}),I.push({oPoint:i[17],oNormal:E[17]}),I.push({oPoint:i[18],oNormal:E[18]}),I.push({oPoint:i[21],oNormal:E[21]}),d=new Array,C=new Array,T=new Array,F=new Array,f=new Array;for(r=0;r<HOLE_CENTER_POS.length;r++){var l=new CVector2;l.set(HOLE_CENTER_POS[r].x,HOLE_CENTER_POS[r].y),d.push(l)}C.push(d[0]),C.push(d[1]),T.push(d[1]),T.push(d[2]),f.push(d[3]),f.push(d[4]),F.push(d[4]),F.push(d[5])},this.addEventListener=function(e,t,r){h[e]=t,_[e]=r},this.verifyCollisionBallWithRectArea=function(e){return m.x=e.getX()-BALL_RADIUS,m.y=e.getY()-BALL_RADIUS,RECT_COLLISION.contains(e.getX(),e.getY())},this._chooseQuadrant=function(e){return e.getX()<TABLE_CENTER.x?e.getY()<TABLE_CENTER.y?0:3:e.getY()<TABLE_CENTER.y?1:2},this.addBallToStack=function(e,t){if(s_iGameMode!==GAME_MODE_TIME)if(0===e.getNumber())e.setPos(CANVAS_WIDTH+BALL_DIAMETER,CUE_BALL_POS.y),e.setTmpForce(0,0),e.setCurForce(0,0);else switch(s_iGameMode){case GAME_MODE_NINE:9===e.getNumber()?(e.setPos(0,0),e.setFlagOnTable(!1),e.setTmpForce(0,0),e.setCurForce(0,0),e.setVisible(!1)):(e.inHole(t),e.setScale(.9),e.scalarProductTmpForce(.9),e.setMask(t.getX(),t.getY()));break;case GAME_MODE_EIGHT:e.inHole(t),e.setScale(.9),e.scalarProductTmpForce(.9),e.setMask(t.getX(),t.getY())}else 0===e.getNumber()?(e.setTmpForce(0,0),e.setCurForce(0,0),e.setFlagOnTable(!1),e.setVisible(!1)):(e.inHole(t),e.setScale(.9),e.scalarProductTmpForce(.9),e.setMask(t.getX(),t.getY()))},this.collideBallWithHoles=function(e,t){return distance(e.getPos(),t[0])<BALL_RADIUS?(h[ON_BALL_INTO_HOLE]&&h[ON_BALL_INTO_HOLE].call(_[ON_BALL_INTO_HOLE],e),t[0]):distance(e.getPos(),t[1])<BALL_RADIUS?(h[ON_BALL_INTO_HOLE]&&h[ON_BALL_INTO_HOLE].call(_[ON_BALL_INTO_HOLE],e),t[1]):null},this.collideBallWithPointsNormals=function(e,t,r){for(var o=0;o<r.length;o++)if(distance2(r[o].oPoint,t)<=BALL_RADIUS_QUADRO){reflectVectorV2(e.getCurForce(),r[o].oNormal);var s=e.getCurForceLen();return e.setCurForceV(r[o].oNormal),e.scalarProductCurForce(s),null!==e.getHole()&&h[ON_BALL_WITH_BANK]&&h[ON_BALL_WITH_BANK].call(_[ON_BALL_WITH_BANK],e),!0}return!1},this.collideBallWithBalls=function(e){if(null!==e.getHole())return!1;for(var t,r,o=new Array,s=1e4,a=0;a<L.length;a++)L[a].getNumber()!==e.getNumber()&&L[a].isBallOnTable()&&null===L[a].getHole()&&(t=distance2(e.getPos(),L[a].getPos()))<=BALL_DIAMETER_QUADRO&&(o.push({oBall:L[a],iDist:t,index_ball:a}),t<s&&(s=t,r=o.length-1));if(0===o.length)return!1;var l=new CVector2,n=new CVector2,i=new CVector2;i.setV(e.getCurForce()),i.invert(),i.normalize(),n.setV(e.getPos()),n.subtract(o[r].oBall.getPos()),n.normalize(),l.setV(n),l.scalarProduct(1.05*BALL_DIAMETER),l.add(o[r].oBall.getPos()),e.setPosV(l);var u=angleBetweenVectors(i,n)/HALF_PI;0===e.getNumber()&&u<.3?(c=s_oInterface.getBackSpin(),l=new CVector2,n.getNormalize(l),this._addSideSpinEffect(i,-1,i,e),c=this._addBackSpinEffect(e,c,n,i)):((i=new CVector2).setV(e.getCurForce()),i.normalize(),c=e.getCurForceLen(),e.setCurForceV(reflectVectorV2(n,i)));var c=c*K_IMPACT_BALL;return e.normalizeCurForce(),e.scalarProductCurForce(.8*c*u+.15*c),n.invert(),n.normalize(),n.scalarProduct(c*(1-u)+.2*c),o[r].oBall.addForce(n),h[ON_BALL_WITH_BALL]&&h[ON_BALL_WITH_BALL].call(_[ON_BALL_WITH_BALL],e,o[r].oBall,c),0===e.getNumber()&&s_oTable.setFirstBallCollision(o[0].oBall),!0},this._addBackSpinEffect=function(e,t,r,o){var s=e.getCurForceLen(),a=new CVector2;return a.setV(e.getCurForce()),0===t?(a.normalize(),s=e.getCurForceLen(),e.setCurForceV(reflectVectorV2(r,a))):(r=linearFunction(t,0,MAX_SPIN_VALUE,0,MAX_BACK_SPIN_CUE_FORCE),a=e.getCurForceLen()/MAX_POWER_FORCE_BALL,s=e.getCurForceLen()+r*a,t<0&&e.setCurForceV(o)),s},this.collideBallWithEdges=function(e,t,r){var o=new CVector2;o.setV(e.getCurForce()),o.normalize();var s=e.getCurForceLen();if(0===s)return!1;var a=Math.floor(s/.2),l=!1,n=new CVector2;n.setV(e.getPrevPos()),o.normalize(),o.scalarProduct(.2);for(var i,u=0;u<a+1;u++){if(u===a&&(o.normalize(),o.scalarProduct(s-.2*a)),n.add(o),!this.verifyCollisionBallWithRectArea(n)){if(this.collideBallWithPointsNormals(e,n,r))return n.subtract(o),e.setPosV(n),!0;for(var c=0;c<t.length;c++)if(l=collideEdgeWithCircle(t[c],n,BALL_RADIUS,null)){n.subtract(o);break}if(l){h[ON_BALL_WITH_BANK]&&h[ON_BALL_WITH_BANK].call(_[ON_BALL_WITH_BANK],e,t[c]);break}}if(e.setPosV(n),this.collideBallWithBalls(e))return!1}return l?(i=reflectVectorV2(e.getCurForce(),t[c].getNormal()),e.setPosV(n),0===e.getNumber()&&this._addSideSpinEffect(i,1,t[c].calculateEdgeVector(),e),e.setCurForceV(i),i=null):e.addPos(e.getCurForce()),e.setPosV(n),!this.collideBallWithBalls(e)&&(o=n=null,l)},this._addSideSpinEffect=function(e,t,r,o){var s,a,l=o.getCurForce().length(),n=o.getSideEffect();0!==n&&(o.setSideEffect(.25*n),s=n/MAX_SPIN_VALUE,s*=MAX_SPIN_VALUE,a=radiantsToDegrees(angleBetweenVectors(e,r)),o=new CVector2(e.getX(),e.getY()),r=a<(a=radiantsToDegrees(angleBetweenVectors(o,r))),n=0<n,o.set(e.getX(),e.getY()),l=linearFunction(l,MAX_POWER_FORCE_BALL,0,.4,.7),n||r?r&&n&&a<90&&(s*=-1):a<90&&(s*=-1),rotateVector2D(toRadian(s*(t-l)),o),e.set(o.getX(),o.getY()))},this.checkBallPosInHole=function(e,t){var r;null!==t&&0!==e.getNumber()&&e.isBallOnTable()&&((r=new CVector2).setV(t),(e.getCurForceLenght2()<K_MIN_FORCE||distance(e.getPos(),r)>DIST_BALL_HOLE)&&(e.setFlagOnTable(!1),setTimeout(function(){o.respawnBallInRails(e)},2e3)))},this.respawnBallInRails=function(e){e.reset3DObjectTransformation(),e.setScale(1),e.setPos(POS_RAIL_EXIT.x,POS_RAIL_EXIT.y),e.setTmpForce(0,0),s_iGameMode===GAME_MODE_NINE?e.setCurForce(3*(BALL_NUMBER-t)/BALL_NUMBER,0):e.setCurForce(8.98*(BALL_NUMBER-t)/BALL_NUMBER,0),t+=.76,e.removeMask()},this.areBallsStopped=function(){return u},this.getEdgesByHoleID=function(e){var t=null;switch(e){case 0:t=c;break;case 1:t=[n[1],n[5]];break;case 2:t=g;break;case 3:t=A;break;case 4:t=[n[13],n[17]];break;case 5:t=N}return t},this.getEdges=function(){return[c[0],g[0],g[1],A[1],N[0],N[1]]},this.update=function(e){var t;L=e,u=!0;for(var r,o,s,a=0;a<e.length;a++){if((t=e[a]).addCurForce(t.getTmpForce()),t.setTmpForce(0,0),t.setPrevPos(t.getPos()),t.isBallOnTable()){switch(this._chooseQuadrant(t)){case 0:r=C,o=c,s=B;break;case 1:r=T,o=g,s=P;break;case 2:r=f,o=A,s=O;break;case 3:r=F,o=N,s=I}if(null===t.getHole()){var l=this.collideBallWithHoles(t,r);if(null!==l){this.addBallToStack(t,l);var n=new CVector2;n.set(l.getX()-t.getX(),l.getY()-t.getY()),n.normalize();for(var i=0;i<5;i++)t.addPos(n)}else this.collideBallWithEdges(t,o,s)}else this.collideBallWithEdges(t,p,s),this.checkBallPosInHole(t,t.getHole())}else t.addPos(t.getCurForce());t.scalarProductCurForce(K_FRICTION),t.getCurForceLenght2()<K_MIN_FORCE?t.setCurForce(0,0):t.isBallOnTable()&&(u=!1)}},this._init(e)}